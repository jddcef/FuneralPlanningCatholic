<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOCX Recreation Test Matrix</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; }
        .container { border: 1px solid #ccc; padding: 15px; margin-top: 20px; border-radius: 5px; }
        .method-container { margin-bottom: 30px; }
        .matrix-selection { display: flex; justify-content: space-around; }
        .selection-group { border: 1px solid #eee; padding: 10px; border-radius: 5px; }
        h2 { border-bottom: 1px solid #ccc; padding-bottom: 5px; }
        h3 { margin-top: 0; }
        button { font-size: 1em; padding: 10px 15px; border-radius: 5px; cursor: pointer; border: 1px solid #999; margin-top: 10px;}
        .run-btn { background-color: #28a745; color: white; border-color: #28a745; }
        .run-btn:disabled { background-color: #ccc; border-color: #ccc; cursor: not-allowed; }
        label { display: block; margin-bottom: 5px; }
    </style>
</head>
<body>
    <h1>DOCX Recreation Test Matrix</h1>
    <p>Select a .docx file, then choose a method below to test different recreation strategies.</p>

    <div class="container">
        <h2>1. Select File</h2>
        <input type="file" id="docx-file-input" accept=".docx">
    </div>

    <div id="methods" class="container">
        <h2>2. Choose a Method</h2>

        <!-- Method 1: HTML Conversion -->
        <div class="method-container">
            <h3>Method 1: HTML Conversion (DOCX &rarr; HTML &rarr; DOCX/PDF)</h3>
            <p>This method converts the DOCX to HTML, then back to the selected format. Good for testing library compatibility, but may result in formatting loss.</p>
            <div class="matrix-selection">
                <div class="selection-group">
                    <h4>Readers</h4>
                    <label><input type="radio" name="html-reader" value="docx-preview" checked> docx-preview</label>
                    <label><input type="radio" name="html-reader" value="mammoth"> mammoth.js</label>
                </div>
                <div class="selection-group">
                    <h4>Writers</h4>
                    <label><input type="radio" name="html-writer" value="html-docx-js" checked> html-docx-js</label>
                    <label><input type="radio" name="html-writer" value="docxjs"> docx.js</label>
                    <label><input type="radio" name="html-writer" value="docxtemplater"> docxtemplater</label>
                </div>
                <div class="selection-group">
                    <h4>Output Format</h4>
                    <label><input type="radio" name="html-format" value="docx" checked> DOCX</label>
                    <label><input type="radio" name="html-format" value="pdf"> PDF</label>
                </div>
            </div>
            <button id="run-html-test-btn" class="run-btn">Run HTML Conversion Test</button>
        </div>

        <hr>

        <!-- Method 2: High-Fidelity Pass-Through -->
        <div class="method-container">
            <h3>Method 2: High-Fidelity Pass-Through (DOCX &rarr; Internal Model &rarr; DOCX)</h3>
            <p>This method loads the DOCX into a library's internal model and saves it again. This is the best method for testing formatting retention.</p>
            <button id="run-docx4js-passthrough-btn" class="run-btn">Run docx4js Pass-Through</button>
            <button id="run-docxjs-passthrough-btn" class="run-btn">Run docx.js Pass-Through</button>
        </div>
    </div>

    <div class="container">
        <h2>Intermediate HTML Output</h2>
        <div id="html-output" style="height: 200px; overflow-y: scroll; border: 1px solid #eee; padding: 10px; background: #f8f8f8;">
            <!-- Intermediate HTML will be shown here -->
        </div>
    </div>

    <script src="https://unpkg.com/jszip/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx-preview@0.1.13/dist/docx-preview.min.js"></script>
    <script>
      window.docxPreview = window.docx;
    </script>
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx@9.5.1/dist/index.iife.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.10.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.4/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.31.2/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script type="module">
        import docx4js from 'https://cdn.jsdelivr.net/npm/docx4js@3.1.1/dist/docx4js.js';

        document.addEventListener('DOMContentLoaded', function () {
            const fileInput = document.getElementById('docx-file-input');
            const runHtmlTestBtn = document.getElementById('run-html-test-btn');
            const runDocx4jsPassthroughBtn = document.getElementById('run-docx4js-passthrough-btn');
            const runDocxjsPassthroughBtn = document.getElementById('run-docxjs-passthrough-btn');
            const htmlOutput = document.getElementById('html-output');

            const getFileAsArrayBuffer = () => {
                return new Promise((resolve, reject) => {
                    if (fileInput.files.length === 0) {
                        alert("Please select a file first.");
                        return reject(new Error("No file selected"));
                    }
                    const fileReader = new FileReader();
                    fileReader.onload = (e) => resolve(e.target.result);
                    fileReader.onerror = (e) => reject(e.target.error);
                    fileReader.readAsArrayBuffer(fileInput.files[0]);
                });
            };

            runHtmlTestBtn.addEventListener('click', async () => {
                try {
                    const reader = document.querySelector('input[name="html-reader"]:checked').value;
                    const writer = document.querySelector('input[name="html-writer"]:checked').value;
                    const format = document.querySelector('input[name="html-format"]:checked').value;
                    const arrayBuffer = await getFileAsArrayBuffer();

                    console.log(`Running HTML test with Reader: ${reader}, Writer: ${writer}, Format: ${format}`);

                    const html = await runHtmlReader(reader, arrayBuffer);
                    htmlOutput.innerHTML = html;

                    const fileName = `recreated-html-${reader}-${writer}.${format}`;
                    if (format === 'pdf') {
                        await runPdfWriter(html, fileName);
                    } else {
                        await runHtmlWriter(writer, html, fileName);
                    }
                } catch (err) {
                    console.error("HTML Conversion Test Error:", err);
                    if (err.message !== "No file selected") {
                        alert(`An error occurred: ${err.message}`);
                    }
                }
            });

            runDocx4jsPassthroughBtn.addEventListener('click', async () => {
                try {
                    const arrayBuffer = await getFileAsArrayBuffer();
                    console.log("Running docx4js pass-through test.");
                    const doc = await docx4js.load(arrayBuffer);
                    htmlOutput.textContent = 'Pass-through test does not generate HTML.';
                    const blob = await doc.save();
                    window.saveAs(blob, 'recreated-passthrough-docx4js.docx');
                } catch (err) {
                    console.error("Pass-through Test Error:", err);
                    if (err.message !== "No file selected") {
                        alert(`An error occurred: ${err.message}`);
                    }
                }
            });

            runDocxjsPassthroughBtn.addEventListener('click', async () => {
                try {
                    const arrayBuffer = await getFileAsArrayBuffer();
                    console.log("Running docx.js pass-through test.");
                    htmlOutput.textContent = 'Pass-through test does not generate HTML.';
                    const blob = await window.docx.patchDocument({
                        outputType: "blob",
                        data: arrayBuffer,
                        patches: {},
                    });
                    window.saveAs(blob, 'recreated-passthrough-docxjs.docx');
                } catch (err) {
                    console.error("Pass-through Test Error:", err);
                    if (err.message !== "No file selected") {
                        alert(`An error occurred: ${err.message}`);
                    }
                }
            });

            function runHtmlReader(reader, arrayBuffer) {
                const container = document.createElement('div');
                switch (reader) {
                    case 'docx-preview':
                        return window.docxPreview.renderAsync(arrayBuffer, container)
                            .then(() => container.innerHTML);
                    case 'mammoth':
                        return window.mammoth.convertToHtml({ arrayBuffer })
                            .then(result => result.value);
                    default:
                        return Promise.reject(new Error(`HTML Reader not implemented: ${reader}`));
                }
            }

            function runPdfWriter(html, fileName) {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();
                const container = document.createElement('div');
                container.innerHTML = html;
                document.body.appendChild(container);

                return window.html2canvas(container, { useCORS: true }).then(canvas => {
                    document.body.removeChild(container);
                    const imgData = canvas.toDataURL('image/png');
                    const imgProps = pdf.getImageProperties(imgData);
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    pdf.save(fileName);
                });
            }

            function runHtmlWriter(writer, html, fileName) {
                switch (writer) {
                    case 'docxtemplater':
                        const templateDoc = new window.docx.Document({
                            sections: [{ children: [new window.docx.Paragraph(new window.docx.TextRun("{content}"))] }],
                        });
                        return window.docx.Packer.toBlob(templateDoc).then(templateBlob => {
                            return new Promise((resolve, reject) => {
                                const fr = new FileReader();
                                fr.onload = () => {
                                    const zip = new window.PizZip(fr.result);
                                    const doc = new window.docxtemplater(zip);
                                    doc.render({ content: html });
                                    const out = doc.getZip().generate({ type: 'blob' });
                                    window.saveAs(out, fileName);
                                    resolve();
                                };
                                fr.onerror = reject;
                                fr.readAsArrayBuffer(templateBlob);
                            });
                        });
                    case 'html-docx-js':
                        const simplifiedHtml = html.replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '');
                        var converted = window.htmlDocx.asBlob(simplifiedHtml);
                        window.saveAs(converted, fileName);
                        return Promise.resolve();
                    case 'docxjs':
                        const parser = new DOMParser();
                        const htmlDoc = parser.parseFromString(html, 'text/html');
                        const paragraphs = Array.from(htmlDoc.querySelectorAll('p')).map(p =>
                            new window.docx.Paragraph({ children: [new window.docx.TextRun(p.textContent)] })
                        );
                        const newDoc = new window.docx.Document({ sections: [{ children: paragraphs }] });
                        return window.docx.Packer.toBlob(newDoc).then(blob => {
                            window.saveAs(blob, fileName);
                        });
                    default:
                        return Promise.reject(new Error(`HTML Writer not implemented: ${writer}`));
                }
            }
        });
    </script>
</body>
</html>
