<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOCX Recreation Test</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        #docx-container { border: 1px solid #ccc; padding: 10px; margin-top: 20px; }
    </style>
</head>
<body>
    <h1>DOCX Recreation Test</h1>
    <p>Upload a .docx file and click the buttons to recreate it using different libraries.</p>

    <input type="file" id="docx-file-input" accept=".docx">
    <hr>

    <h2>Method 1: DOCX -> HTML -> DOCX</h2>
    <button id="recreate-via-html-btn" disabled>Recreate via HTML</button>
    <div id="docx-container"></div>

    <hr>

    <h2>Method 2: Direct creation with docx.js</h2>
    <button id="recreate-direct-btn" disabled>Recreate directly</button>

    <script src="https://unpkg.com/jszip/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx-preview@0.1.13/dist/docx-preview.min.js"></script>
    <script>
      // Rename the global `docx` object from docx-preview to avoid conflicts
      window.docxPreview = window.docx;
    </script>
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx@9.5.1/dist/index.iife.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const fileInput = document.getElementById('docx-file-input');
            const recreateViaHtmlBtn = document.getElementById('recreate-via-html-btn');
            const recreateDirectBtn = document.getElementById('recreate-direct-btn');
            const docxContainer = document.getElementById('docx-container');

            let docxFile = null;

            fileInput.addEventListener('change', function (event) {
                docxFile = event.target.files[0];
                if (docxFile) {
                    recreateViaHtmlBtn.disabled = false;
                    recreateDirectBtn.disabled = false;
                } else {
                    recreateViaHtmlBtn.disabled = true;
                    recreateDirectBtn.disabled = true;
                }
            });

            recreateViaHtmlBtn.addEventListener('click', function () {
                if (!docxFile) {
                    alert('Please select a .docx file first.');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (e) {
                    const arrayBuffer = e.target.result;

                    // 1. Render docx to HTML using docx-preview
                    docxPreview.renderAsync(arrayBuffer, docxContainer)
                        .then(function () {
                            console.log("DOCX rendered successfully.");

                            // 2. Get the HTML content
                            const content = docxContainer.innerHTML;
                            const htmlContent = `
                                <!DOCTYPE html>
                                <html>
                                <head>
                                    <meta charset="UTF-8">
                                </head>
                                <body>
                                    ${content}
                                </body>
                                </html>
                            `;

                            // 3. Convert HTML to DOCX
                            const converted = htmlDocx.asBlob(htmlContent);

                            // 4. Save the DOCX file
                            saveAs(converted, 'recreated-via-html.docx');
                        })
                        .catch(function (error) {
                            console.error('Error rendering DOCX:', error);
                            alert('An error occurred while rendering the DOCX file.');
                        });
                };
                reader.readAsArrayBuffer(docxFile);
            });

            recreateDirectBtn.addEventListener('click', function () {
                if (!docxFile) {
                    alert('Please select a .docx file first.');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (e) {
                    const arrayBuffer = e.target.result;

                    JSZip.loadAsync(arrayBuffer).then(function (zip) {
                        zip.file("word/document.xml").async("string").then(function (content) {
                            const parser = new DOMParser();
                            const xmlDoc = parser.parseFromString(content, "text/xml");
                            const textNodes = xmlDoc.getElementsByTagName("w:t");

                            const paragraphs = [];
                            for (let i = 0; i < textNodes.length; i++) {
                                paragraphs.push(new docx.Paragraph({
                                    children: [new docx.TextRun(textNodes[i].textContent)]
                                }));
                            }

                            const doc = new docx.Document({
                                sections: [{
                                    children: paragraphs,
                                }, ],
                            });

                            docx.Packer.toBlob(doc).then(blob => {
                                console.log("Document created successfully");
                                saveAs(blob, "recreated-direct.docx");
                            });
                        });
                    });
                };
                reader.readAsArrayBuffer(docxFile);
            });
        });
    </script>
</body>
</html>
